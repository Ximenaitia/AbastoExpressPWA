# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master
- develop

pool:
  vmImage: 'ubuntu-latest'

stages:
# STAGE 1: BUILD - Vinculado a TAREAS DE COMPILACIÃ“N
- stage: Build
  displayName: 'ğŸ”¨ Build Stage - CompilaciÃ³n MÃ³dulos'
  jobs:
  - job: Build_Authentication
    displayName: 'CompilaciÃ³n MÃ³dulo AutenticaciÃ³n (US001)'
    steps:
    - script: |
        echo "ğŸ“¦ Compilando mÃ³dulo autenticaciÃ³n con dependencias de seguridad"
        echo "âœ… Vinculado a: CompilaciÃ³n mÃ³dulo autenticaciÃ³n con dependencias de seguridad"
        # npm run build:auth || dotnet build Auth.sln
      displayName: 'Build Auth Module'
    
  - job: Build_Products
    displayName: 'CompilaciÃ³n MÃ³dulo Productos (US002)'
    steps:
    - script: |
        echo "ğŸ“¦ Compilando mÃ³dulo productos con dependencias de catÃ¡logo"
        echo "âœ… Vinculado a: CompilaciÃ³n mÃ³dulo productos con dependencias de catÃ¡logo"
        # npm run build:products || dotnet build Products.sln
      displayName: 'Build Products Module'

  - job: Build_Inventory
    displayName: 'CompilaciÃ³n MÃ³dulo Inventario (US003)'
    steps:
    - script: |
        echo "ğŸ“¦ Compilando mÃ³dulo inventario con manejo de estados"
        echo "âœ… Vinculado a: CompilaciÃ³n mÃ³dulo inventario con manejo de estados"
        # npm run build:inventory || dotnet build Inventory.sln
      displayName: 'Build Inventory Module'

# STAGE 2: TEST - Vinculado a TAREAS DE PRUEBAS
- stage: Test
  displayName: 'ğŸ§ª Test Stage - Pruebas Automatizadas'
  dependsOn: Build
  jobs:
  - job: Test_Security
    displayName: 'Pruebas Seguridad Login (US001)'
    steps:
    - script: |
        echo "ğŸ”’ Ejecutando pruebas unitarias de seguridad y validaciÃ³n login"
        echo "âœ… Vinculado a: EjecuciÃ³n pruebas unitarias de seguridad y validaciÃ³n login"
        # npm test:security || dotnet test SecurityTests.csproj
      displayName: 'Security Tests'
    
    - publish: $(System.DefaultWorkingDirectory)/test-reports
      artifact: security-test-logs

  - job: Test_API_Products
    displayName: 'Pruebas API CRUD Productos (US002)'
    steps:
    - script: |
        echo "ğŸ›’ Ejecutando pruebas API CRUD productos y validaciÃ³n IDs Ãºnicos"
        echo "âœ… Vinculado a: EjecuciÃ³n pruebas API CRUD productos y validaciÃ³n IDs Ãºnicos"
        # npm test:products || dotnet test Products.API.Tests.csproj
      displayName: 'Products API Tests'

  - job: Test_Inventory
    displayName: 'Pruebas Inventario (US003)'
    steps:
    - script: |
        echo "ğŸ“Š Ejecutando pruebas automatizadas actualizaciÃ³n inventario y notificaciones"
        echo "âœ… Vinculado a: EjecuciÃ³n pruebas automatizadas actualizaciÃ³n inventario y notificaciones"
        # npm test:inventory || dotnet test Inventory.Tests.csproj
      displayName: 'Inventory Tests'

# STAGE 3: DEPLOY - Vinculado a TAREAS DE DESPLIEGUE
- stage: Deploy
  displayName: 'ğŸš€ Deploy Stage - Despliegue a Staging'
  dependsOn: Test
  jobs:
  - job: Deploy_Auth_Staging
    displayName: 'Despliegue AutenticaciÃ³n (US001)'
    steps:
    - script: |
        echo "ğŸŒ Desplegando autenticaciÃ³n a entorno staging con configuraciÃ³n segura"
        echo "âœ… Vinculado a: Despliegue automÃ¡tico a entorno staging con configuraciÃ³n segura"
        # az webapp deployment source config --name my-auth-app
      displayName: 'Deploy Auth to Staging'

  - job: Deploy_Products_Docker
    displayName: 'Despliegue Productos Docker (US002)'
    steps:
    - script: |
        echo "ğŸ³ Desplegando contenedores Docker para mÃ³dulo de productos"
        echo "âœ… Vinculado a: Despliegue contenedores Docker para mÃ³dulo de productos"
        # docker-compose up -d
      displayName: 'Deploy Products Containers'

  - job: Deploy_Inventory_K8s
    displayName: 'Despliegue Inventario Kubernetes (US003)'
    steps:
    - script: |
        echo "â˜¸ï¸ Desplegando contenedores Kubernetes para servicio de inventario"
        echo "âœ… Vinculado a: Despliegues contenedores Kubernetes para servicio de inventario"
        # kubectl apply -f inventory-deployment.yaml
      displayName: 'Deploy Inventory to K8s'

# STAGE 4: MONITOR - Vinculado a TAREAS DE MONITOREO
- stage: Monitor
  displayName: 'ğŸ“Š Monitor Stage - Alertas y MÃ©tricas'
  dependsOn: Deploy
  jobs:
  - job: Monitor_Auth
    displayName: 'Monitoreo AutenticaciÃ³n (US001)'
    steps:
    - script: |
        echo "ğŸš¨ Configurando alertas de errores de autenticaciÃ³n y logs"
        echo "âœ… Vinculado a: ConfiguraciÃ³n de alertas de errores de autenticaciÃ³n y logs"
        echo "ğŸ”” Alertas configuradas: Failed Logins, Security Breaches"
      displayName: 'Auth Monitoring Setup'

  - job: Monitor_Products
    displayName: 'Dashboard Productos (US002)'
    steps:
    - script: |
        echo "ğŸ“ˆ ConfiguraciÃ³n dashboard monitoreo consultas y rendimiento catÃ¡logo"
        echo "âœ… Vinculado a: ConfiguraciÃ³n dashboard monitoreo consultas y rendimiento catÃ¡logo"
        echo "ğŸ“Š Dashboard: Product Views, API Response Times"
      displayName: 'Products Dashboard'

  - job: Monitor_Inventory
    displayName: 'Alertas Inventario (US003)'
    steps:
    - script: |
        echo "âš ï¸ ConfiguraciÃ³n alertas rendimiento y monitoreo existencias en tiempo real"
        echo "âœ… Vinculado a: ConfiguraciÃ³n alertas rendimiento y monitoreo existencias en tiempo real"
        echo "ğŸ”” Alertas: Low Stock, Inventory Sync Errors"
      displayName: 'Inventory Alerts'

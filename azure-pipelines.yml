# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master
- develop

pool:
  vmImage: 'ubuntu-latest'

stages:
# STAGE 1: BUILD - Un solo job con todos los módulos
- stage: Build
  displayName: '🔨 Build Stage'
  jobs:
  - job: Build_All
    displayName: 'Compilación Todos los Módulos'
    steps:
    - script: |
        echo "📦 COMPILANDO MÓDULO AUTENTICACIÓN (US001)"
        echo "✅ Vinculado a: Compilación módulo autenticación con dependencias de seguridad"
        echo "📦 COMPILANDO MÓDULO PRODUCTOS (US002)" 
        echo "✅ Vinculado a: Compilación módulo productos con dependencias de catálogo"
        echo "📦 COMPILANDO MÓDULO INVENTARIO (US003)"
        echo "✅ Vinculado a: Compilación módulo inventario con manejo de estados"
      displayName: 'Build All Modules'

# STAGE 2: TEST - Un solo job con todas las pruebas
- stage: Test
  displayName: '🧪 Test Stage'
  dependsOn: Build
  jobs:
  - job: Test_All
    displayName: 'Ejecutar Todas las Pruebas'
    steps:
    - script: |
        echo "🔒 PRUEBAS SEGURIDAD LOGIN (US001)"
        echo "✅ Vinculado a: Ejecución pruebas unitarias de seguridad y validación login"
        echo "🛒 PRUEBAS API CRUD PRODUCTOS (US002)"
        echo "✅ Vinculado a: Ejecución pruebas API CRUD productos y validación IDs únicos"
        echo "📊 PRUEBAS INVENTARIO (US003)"
        echo "✅ Vinculado a: Ejecución pruebas automatizadas actualización inventario"
      displayName: 'Run All Tests'

# STAGE 3: DEPLOY - Un solo job con todos los despliegues
- stage: Deploy
  displayName: '🚀 Deploy Stage'
  dependsOn: Test
  jobs:
  - job: Deploy_All
    displayName: 'Despliegue Completo'
    steps:
    - script: |
        echo "🌐 DESPLIEGUE AUTENTICACIÓN (US001)"
        echo "✅ Vinculado a: Despliegue automático a entorno staging con configuración segura"
        echo "🐳 DESPLIEGUE PRODUCTOS DOCKER (US002)"
        echo "✅ Vinculado a: Despliegue contenedores Docker para módulo de productos"
        echo "☸️ DESPLIEGUE INVENTARIO KUBERNETES (US003)"
        echo "✅ Vinculado a: Despliegues contenedores Kubernetes para servicio de inventario"
      displayName: 'Deploy All Services'

# STAGE 4: MONITOR - Un solo job con todo el monitoreo
- stage: Monitor
  displayName: '📊 Monitor Stage'
  dependsOn: Deploy
  jobs:
  - job: Monitor_All
    displayName: 'Configuración Monitoreo'
    steps:
    - script: |
        echo "🚨 MONITOREO AUTENTICACIÓN (US001)"
        echo "✅ Vinculado a: Configuración de alertas de errores de autenticación y logs"
        echo "📈 DASHBOARD PRODUCTOS (US002)"
        echo "✅ Vinculado a: Configuración dashboard monitoreo consultas y rendimiento catálogo"
        echo "⚠️ ALERTAS INVENTARIO (US003)"
        echo "✅ Vinculado a: Configuración alertas rendimiento y monitoreo existencias"
        echo "🎯 PIPELINE EJECUTADO EXITOSAMENTE - TODAS LAS ETAPAS COMPLETADAS"
      displayName: 'Setup All Monitoring'